#!/bin/bash
#
# Cree la page HTML du suivi du calcul :
#

ETUDE_TRUST=`QUELLE_ETUDE.ihm`
export ETUDE_TRUST
NOMETUDE=`echo $ECHO_OPTS $ETUDE_TRUST | $TRUST_Awk '{n=split($0,a,"/");print a[n]}'`
NOM_DATA=$ETUDE_TRUST/.NOM_DATA
[ ${#PORT} = 0 ] && PORT=`cat $TRUST_TMP/.PORT` && export PORT
cd $ETUDE_TRUST
fichier=$ETUDE_TRUST/.Liste.son.html  
#######################
# Ecriture du fichier :
#######################
cree_en_tete.ihm > $fichier
echo $ECHO_OPTS "<SCRIPT LANGUAGE="JavaScript">
<!--
parent.DOWN.location.replace('file:$HOME');
function viewer(url)
{
var aff=window.open (url,'aff','location=yes,toolbar=yes,directories=no,menubar=yes,resizable=yes,scrollbars=yes,status=yes,width=640,height=800');
aff.focus();
}
function go_toC(url)
{
void(parent.DOWN.location.replace(\"http://localhost:$PORT/ordre.cg?0\"));
location.href=url;
}
function go_toF(url)
{
void(parent.DOWN.location.replace(\"http://localhost:$PORT/ordre.cg?1\"));
location.href=url;
}
//-->
</SCRIPT>" >> $fichier
# On quitte si le nom du cas n'existe pas
[ ! -f $NOM_DATA ] && exit
NOMCAS=`cat $NOM_DATA`
echo $ECHO_OPTS "<PRE>
<HR><h1> Study $NOMETUDE: results evolution</h1><HR><FORM METHOD="Stop" ACTION="$TRUST_ROOT/form/Stopper.ksh?"><input type="submit" value="Stop">\t   Stop solve process</FORM>\c" >> $fichier
if [ -f $TRUST_ROOT/exec/VisIt/bin/visit ]
then
   echo $ECHO_OPTS "<FORM METHOD="Postraiter" ACTION="$TRUST_ROOT/form/Postraiter_Visit.ksh?"><input type="submit" value="VisIt">\t   Post-processing display with <A HREF=javascript:viewer(\"http://www.llnl.gov/VisIt/home.html\")>Visit</A> <A HREF=\"file:$TRUST_ROOT/doc/visit/GettingStarted.pdf\">Getting started manual</A> <A HREF=\"file:$TRUST_ROOT/doc/visit/VisItUsersManual1.5.pdf\">User's manual 1.5</A></FORM>\c" >> $fichier
fi
if [ ${#DV_machines} != 0 ]
then
   echo $ECHO_OPTS "<FORM METHOD="Post-processing" ACTION="$TRUST_ROOT/form/Postraiter_DV.ksh?"><input type="submit" value="Data_Visualizer"> Post-processing display with Data Visualizer</FORM>\c" >> $fichier
fi
if [ ${#AVS_machines} != 0 ]
then
   echo $ECHO_OPTS "<FORM METHOD="Post-processing" ACTION="$TRUST_ROOT/form/Postraiter_AVS.ksh?"><input type="submit" value="AVS/Express">     Post-processing display with AVS/Express</FORM>\c" >> $fichier
fi
echo $ECHO_OPTS "<FORM METHOD="Close" ACTION="$TRUST_ROOT/form/Fermer_calcul.ksh?"><input type="submit" value="Close">\t  Close the process windows</FORM>\c" >> $fichier
echo $ECHO_OPTS "<FORM METHOD="ReOpen" ACTION="http://localhost:$PORT/ordre.cg?"><input type="submit" value="ReOpen">\tReOpen the process windows</FORM>\c" >> $fichier
# <FORM METHOD="Print" ACTION="$TRUST_ROOT/form/Imprimer_courbe.ksh?"><input type="submit" value="Print">\tPrint a curve</FORM>
#<h3>Courbes disponibles :</h3>" > $fichier
# Lecture du nom du cas:
NOM=`cat $ETUDE_TRUST/.NOM_DATA`
export NOM
REP=$TRUST_ROOT/IHM

# Statistiques
stat=$ETUDE_TRUST/.stat.html
# Calcul de $tinit et $tstop par analyse des fichiers .son ?
tinit=`grep -i tinit $NOM.data 2>/dev/null | $TRUST_Awk 'BEGIN {t=0} {t=$2} END {print t}'`
tstop=`grep -i tmax $NOM.data 2>/dev/null | $TRUST_Awk 'BEGIN {t=0} {t=$2} END {print t}'`
cree_en_tete.ihm > $stat

# Affichage maillage ?
#if [ -f $NOM.meshtv ]
#then
   # Options supplementaires
#   echo $ECHO_OPTS "<LI><a href="$REP/Maillage.meshtv">Afficher maillage</a><HR>" >> $fichier
#fi
# Construction de gnuplot/$NOM.menu et quitte si n'existe pas
[ -s $NOM.data ] && [ "`grep -i dimension $NOM.data`" != "" ] && echo | $TRUST_Awk -v NOM=$NOM -f $TRUST_AWK/Run_sonde_awk
echo $ECHO_OPTS "<PRE><HR><h1>Statistical calculations for study $NOMETUDE</h1><HR><FORM METHOD=\"CALCUL\" ACTION="http://localhost:$PORT/statistic.cg" TARGET=\"RIGHT\">     
tmin:<input type="text" name="tmin" size=6 value="$tinit"> tmax:<input type="text" name="tmax" size=6 value="$tstop"> <input type="submit" value="Calculate">" >> $stat
# replace c'est pour la supprimer de l'historique !!!
# meta ne marche pas ?
js="javascript:void(parent.DOWN.location.replace(\"http://localhost:$PORT/ordre.cg"

href="" && [ -f $TRUST_ROOT/exec/statistic_on_desactive_car_plus_teste ] && href="<a href=$stat><img src="$REP/Residu.gif" >"Statistics"</a>"
[ -f $NOM.out ] && echo $ECHO_OPTS "<HR><a href=javascript:go_toC(\"$ETUDE_TRUST/.Liste.conv.html\")><img src="$REP/Residu.gif" >"Convergence monitoring"</a> $href" >> $fichier
[ "`ls $NOM*.out 2>/dev/null | grep -v $NOM.out`" != "" ] && echo $ECHO_OPTS "<HR><a href=javascript:go_toF(\"$ETUDE_TRUST/.Liste.flux.html\")><img src="$REP/Probe.gif" >"Boundary fluxes"</a> $href" >> $fichier
if [ -f gnuplot/$NOM.menu ]
then
############################
# Creation des icones sondes
############################
cat gnuplot/$NOM.menu | $TRUST_Awk -v cg=$js -v ETUDE=$ETUDE_TRUST -v REP=$REP -v html=$fichier -v lpnb=${#IMPRESSION} -v lpcou=${#IMPRESSION_COLOR} 'BEGIN{i=1;}{i++;image=REP"/"$2".gif";image1=REP"/"$2"1.gif";image2=REP"/lpnb.gif";image3=REP"/lpcou.gif";image4=REP"/implus.gif";image5=REP"/zoom.gif";image6=REP"/Anim.gif";
com="";for (j=2;j<NF+1;j++) com=com" "$j;
im="<a href="cg"?"i"\"))><img src="image" ></a> ";
im=im"<a href="cg"?-"i"\"))><img src="image1" ></a> ";
if (lpnb!=0) im=im"<a href="cg"?i"i"\"))><img src="image2" ></a> ";
if (lpcou!=0) im=im"<a href="cg"?I"i"\"))><img src="image3" ></a> ";
# if ($2!="Cross") im=im"<a href="cg"?+"i"\"))><img src="image4" ></a> ";
if ($2!="Cross") im=im"<a href="cg"?&"i"\"))><img src="image5" ></a> ";
if ($2=="Profile") im=im"<a href="cg"?"i"F\"))><img src="image6" ></a> ";
print "<HR>"$1" "com"\n"im >> html}'
fi
echo $ECHO_OPTS "</body>
</html> " >> $fichier

############################
# Creation des statistiques
############################
if [ -f gnuplot/$NOM.menu ]
then
dim=`cat gnuplot/$NOM.menu | $TRUST_Awk 'BEGIN {dim=2} /_Z/ {dim=3} END {print dim}'`
cat gnuplot/$NOM.menu | $TRUST_Awk -v dim=$dim -v stat=$stat '{i++;com="";split($1,a,"-");ch=a[2];if ($2!="Cross" && ch!="VELOCITY_Y" && ch!="VELOCITY_Z" && ch!="CORRELATION_TV_VX" && ch!="CORRELATION_TV_VY" && ch!="CORRELATION_TV_VZ" ) {
   for (j=2;j<NF+1;j++) com=com" "$j;
   if (ch=="VELOCITY_X")
   {
      com="VELOCITY "com;
      if (dim==2)
         print "<select name=stat"i"><option selected>No plot<option>moy(U)<option>moy(V)<option>ect(U)<option>ect(V)<option>fluc(U)<option>fluc(V)<option>spe(U)<option>spe(V)<option>moy(uu)<option>moy(uv)<option>moy(vv)</select>" com >> stat ;
      else
         print "<select name=stat"i"><option selected>No plot<option>moy(U)<option>moy(V)<option>moy(W)<option>ect(U)<option>ect(V)<option>ect(W)<option>fluc(U)<option>fluc(V)<option>fluc(W)<option>spe(U)<option>spe(V)<option>spe(V)<option>moy(uu)<option>moy(uv)<option>moy(uw)<option>moy(vv)<option>moy(vw)<option>moy(ww)</select>" com >> stat ;
   }
   else if (ch=="CORRELATION_TV_T")
   {
     com="CORRELATION_TV "com;
      if (dim==2)
         print "<select name=stat"i"><option selected>No plot<option>moy(utheta)<option>moy(vtheta)</select>" com >> stat ;
      else
         print "<select name=stat"i"><option selected>No plot<option>moy(utheta)<option>moy(vtheta)<option>moy(wtheta)</select>" com >> stat ;
   }
   else
   {
      com=ch" "com;
      print "<select name=stat"i"><option selected>No plot<option>moy(X)<option>ect(X)<option>fluc(X)<option>spe(X)</select>" com >> stat ;     
   }
}}'       
echo $ECHO_OPTS "</FORM><HR>
</body>
</html>" >> $stat
    
#############################################          
# Creation de pages html supplementaires pour 
# la superposition de courbes : En construction !
#############################################
NC=`wc -l gnuplot/$NOM.menu | $TRUST_Awk '{print $1}'`
let NUM=0
while [ $NUM != $NC ]
do
   let NUM=$NUM+1
#   cree_Liste.gnu.html $NUM
done
#if ($2!="Plan") im=im"<a href="ETUDE"/.courbe"i".gnu.html><img src="image" ></a> ";
fi


