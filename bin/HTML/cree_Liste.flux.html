#!/bin/bash
#
# Cree la page HTML du suivi des flux du calcul :
#
ETUDE_TRUST=`QUELLE_ETUDE.ihm`
export ETUDE_TRUST
NOMETUDE=`echo $ECHO_OPTS $ETUDE_TRUST | $TRUST_Awk '{n=split($0,a,"/");print a[n]}'`
NOM_DATA=$ETUDE_TRUST/.NOM_DATA
# On quitte si le nom du cas n'existe pas
[ ! -f $NOM_DATA ] && exit
NOMCAS=`cat $NOM_DATA`

cd $ETUDE_TRUST
fichier=$ETUDE_TRUST/.Liste.flux.html
fichier_son=$ETUDE_TRUST/.Liste.son.html
[ ! -f gnuplot/$NOMCAS.sous_menu2 ] && exit
Conv=`wc -l gnuplot/$NOMCAS.sous_menu2 | $TRUST_Awk '{print $1+1}'`
Exit=0 && [ ${#1} != 0 ] && Exit=1
#######################
# Ecriture du fichier :
#######################
cree_en_tete.ihm > $fichier
echo $ECHO_OPTS "<SCRIPT LANGUAGE="JavaScript">
<!--
parent.DOWN.location.replace('file:$HOME');
var num=$Conv;
function viewer(url)
{
var aff=window.open (url,'aff','location=yes,toolbar=yes,directories=no,menubar=yes,resizable=yes,scrollbars=yes,status=yes,width=640,height=800');
aff.focus();
}" >> $fichier
if [ $Conv != 1 ]
then
   Conv_=1
   while (( $Conv_ <= $Conv ))
   do
      echo $ECHO_OPTS "function go_to$Conv_(url)" >> $fichier
      echo $ECHO_OPTS "{" >> $fichier
      echo $ECHO_OPTS "void(parent.DOWN.location.replace(\"http://localhost:$PORT/ordre.cg?$Conv_\"));" >> $fichier
      echo $ECHO_OPTS "location.href=url;" >> $fichier
      echo $ECHO_OPTS "}" >> $fichier
      ((Conv_=Conv_+1))
   done
else
   if [ $Exit = 1 ]
   then
      echo $ECHO_OPTS "window.setTimeout(\"location.replace('$fichier_son')\", 5000);" >> $fichier
   else
      echo $ECHO_OPTS "window.setInterval(\"location.reload(true)\",1000);" >> $fichier
   fi
fi
echo $ECHO_OPTS "//-->
</SCRIPT>" >> $fichier
echo $ECHO_OPTS "<PRE>
<HR><h1> Study $NOMETUDE: Boundary fluxes</h1><HR><FORM METHOD="Stop" ACTION="$TRUST_ROOT/form/Stopper.ksh?"><input type="submit" value="Stop">\t   Stop solve process</FORM>\c" >> $fichier
# <FORM METHOD="Print" ACTION="$TRUST_ROOT/form/Imprimer_courbe.ksh?"><input type="submit" value="Print">\tPrint a curve</FORM>
#<h3>Courbes disponibles :</h3>" > $fichier
# Lecture du nom du cas:
NOM=`cat $ETUDE_TRUST/.NOM_DATA`
export NOM
REP=$TRUST_ROOT/IHM

#js="javascript:void(parent.DOWN.location.replace(\"http://localhost:$PORT/ordre.cg"
js="javascript:go_to"
js1="(\"$ETUDE_TRUST/.Liste.bord.html\")"

if [ $Conv = 1 ]
then
   if [ $Exit = 1 ]
   then
      echo $ECHO_OPTS "You must reopen the process windows in the <a href=\"file:$fichier_son\">"previous page"</a>" >> $fichier
   else
      echo $ECHO_OPTS "<h1>Please wait...</h1>" >> $fichier
   fi
else
   echo $ECHO_OPTS "<HR><a href=javascript:go_to$Conv(\"$ETUDE_TRUST/.Liste.son.html\")><img src="$REP/Probe.gif" >"Back to Results evolution"</a> $href" >> $fichier
############################
# Creation des icones des flux
############################
   cat gnuplot/$NOMCAS.sous_menu2 | $TRUST_Awk -v cg=$js -v cg1=$js1 -v ETUDE=$ETUDE_TRUST -v REP=$REP -v html=$fichier -v lpnb=${#IMPRESSION} -v lpcou=${#IMPRESSION_COLOR} '{i++;image=REP"/Residu.gif";
   com="";for (j=2;j<NF+1;j++) com=com" "$j;
   im="<a href="cg""i""cg1">";
   print "<HR>"im""$1""com"</a>" >> html}'
   echo $ECHO_OPTS "</body>"  >> $fichier
   echo $ECHO_OPTS "</html> " >> $fichier
fi

